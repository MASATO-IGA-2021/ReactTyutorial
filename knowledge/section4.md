# 基本編

## 4.コンポーネント開発(フォーム)

### 4-1.フォームの基本

#### 4-1-1 フォーム管理の基本

- フォームに関わる値はひとつのオブジェクトに束ねる
- フォーム要素の名前(name)属性と State 上のプロパティ名は一致させる
- 要素の名前(e.target.name)をそのままプロパティ名として入力値(e.target.value)を渡す
  ```
  //算出プロパティ名と呼ばれる
  [e.target.name]: e.target.value
  ```
- state を用いて入力を管理する方式のコンポーネントを制御コンポーネント

#### 4-1-2 change イベントの発生タイミング

| イベント | 発生タイミング                                                      |
| -------- | ------------------------------------------------------------------- |
| change   | フォーム要素の内容を変更し、フォーカスを外した(=変更が確定した)とき |
| input    | フォーム要素に何らかの変更が加えられた時                            |

#### 4-1-3 非制御コンポーネントによるフォーム管理

- 非制御コンポーネント：入力値を State で保持しないコンポーネント
- 非制御コンポーネントの場合、要素オブジェクトから直接値を取得する
  `useRef(initial)`
  - initial:初期値

#### 4-1-4 入力要素に応じたフォームの実装

- textarea
- checkbox
- checkbox(multiple)
- radiobutton
- select
- select(multiple)
- file

### 4-2.State における構造化データの更新

- State は常に setXXX 関数経由で更新しなければいけない。⇒State 値の変更を React が認識できないため。

#### 4-2-1 スプレッド構文の意味

```
setForm({
    ...form,
    [e.target.name] : e.target.value
});
```

- `...`演算子はオブジェクトを複製し分解する。
- つまり上記コードは「既存の入力を複製し、更新部分(e.target.name)だけを上書きする」ことを行っている。
- 但し、スプレッド構文による複製者、**浅い複製**であるため、ネストされたオブジェクト(State)を扱う際には要注意。
- 入れ子の State

```
const handleFormNest = (e) => {
    setFormNest(
        ...formNest, #①
        key: {
            ...formNest.key, #②
            [e.target.name]: e.target.value #③
        }
    )
}
```

- ①：State の一次元の階層データを複製して代入
- ②：State の 2 次元目の階層データを複製して代入
- 極力フラットなデータ構造にする方がソースコードは簡単になる。

#### 4-2-2 Immer ライブラリによる改善

- Immer を利用することでハンドラーの共通化を実現できる。

#### 4-2-3 配列の更新

- 配列型の State についても尾オブジェクト型の State 同様直接更新することはできない。

| 操作   | 〇利用するべき       | × 避けるべき       |
| ------ | -------------------- | ------------------ |
| 追加   | concat, [...list]    | push, unshift      |
| 更新   | map                  | plice, list[i] = ~ |
| 削除   | filter, slice        | pop, shift, splice |
| ソート | あらかじめ配列を複製 | sort, reverse      |

- 避けるべきメソッドは、破壊的メソッド(メソッドの処理結果 w 戻り値として返すのではなく、呼び出し元のオブジェクトを直接変更するようなメソッド)

### 4-3.検証機能の実装-React Hook Form

#### 4-3-1 React Hook Form の基本

- **useForm 関数**

```
useForm(opts)
opts:  動作オプション([オプション名:値, ...]形式)
```

- 代表的な動作オプション
  - defaultValues: 各フィールドの既定値
  - mode: 検証を実行するタイミング
- 代表的な戻り値
  - register(...): フォーム要素に紐づけるべきイベントハンドラーなどを含んだオブジェクト
    ```
    # 指定されたフィールドに対するイベントハンドラー、参照を登録するための関数
    register(name, [,ops])
    name: フィールド名
    ops: 動作オプション (オプション名: 値, ...)形式
    ```
  - formState: フォームの状態を表すオブジェクト
  - handleSubmit(onSuc, onErr): サブミット時に実行されるハンドラーを設定
- useForm の戻り値は、フォーム生成に必要な変数・関数を含んだオブジェクト
- 検証結果を参照する errors オブジェクト

  - useForm 関数から取り出した errors オブジェクトの参照で検証成否を取得可能
    errors
    |----フィールド名
    |----type: 検証種類
    |----ref: 対象となる要素の参照
    |----message: エラーメッセージ
  - error.フィールド名が存在しない時は null を返す

- サブミット時に呼び出す処理は handleSubmit 関数

```
handleSubmit(onsubmit, [,onerror])
onsubmit: サブミット時の処理(検証成功時)
onerror: サブミット時の処理(検証失敗時)
```

#### 4-3-2 独自ルールを実装する

- validate オプションを「検証名: 検証ルール, ...」の形式で示す
  - 引数は対象フィールドの入力値(value), フォーム全体の入力値(formValues)
  - 戻り値は検証の成否(成功は true, 失敗時は false またはエラーメッセージ)

#### 4-3-3 フォームの状態に応じて表示を制御する
- formStateオブジェクトを参照することで様々なフォームの状態を検知できる
  - isDirty: ユーザーがいずれかの要素を変更したか
  - isValid: フォームへの入力値が正しいか
  - isValidating: フォームが検証中であるか
#### 4-3-4 検証ライブラリと連携する
- Yupを利用
- Yupを利用するには、yup.objectメソッドでスキーマを設定。
   - スキーマ：フォームの構造を大雑把にはデータ(フィールド)項目とその検証ルールのこと
```
フィールド名:yup
  .データ型()
  .label(フィールド日本名)
  .検証ルール(...).~
```
#### 4-3-5 Yupで独自の検証ルールを実装する
```
test(name, essage, func)
```
  - name: 検証名
  - message: 検証メッセージ
  - func: 検証ルール(引数は入力値, 戻り値は検証の成否)

- 汎用的な検証ルールを追加する
```
addMethod(type, name, method)
```
  - type: データ型
  - name: 検証名
  - method: 検証ルール
```
yup.addMethod(yup.string, ng, function() {
  return this.test('ng',
    ({ label }) => `${label}にNGワードが含まれています。`,
    value => {
      const ngs = ['暴力','死', 'グロ'];
      for (const ng of ngs) {
        if (label.includes(ng)) {
          return false;
        }
      }
      return true;
    }
  )
})
```
#### 4-3-6 Yupで入力値を変換する
- 変換ルールを自作する
  - transformメソッド：変換ルール(関数)を引数として受け取る。
    - 引数として、「ここまでの変換済みの値(value)」「元の値(orgValue)」を受け取る
    - 戻り値として変換済みの値を返すこと

#### 4-3-7 Yupのエラーメッセージを日本語化する
- yupオブジェクトにエラーメッセージを設定しyupオブジェクトをスキーマ設定すると設定済みのエラーメッセージを利用することができる。